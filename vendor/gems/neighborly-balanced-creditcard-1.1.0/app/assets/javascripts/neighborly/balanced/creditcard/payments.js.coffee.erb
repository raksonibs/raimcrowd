Neighborly.Neighborly                              ?= {}
Neighborly.Neighborly.Balanced                     ?= {}
Neighborly.Neighborly.Balanced.Creditcard          ?= {}
Neighborly.Neighborly.Balanced.Creditcard.Payments ?= {}

stripeResponseHandler = (status, response) ->
  $form = $("#payment-form")
  if response.error
    
    # Show the errors on the form
    $form.find(".payment-errors").text response.error.message
    $form.find("button").prop "disabled", false
  else
    
    # token contains id, last4, and card type
    token = response.id
    
    # Insert the token into the form so it gets submitted to the server
    $form.append $("<input type=\"hidden\" name=\"stripeToken\" />").val(token)
    
    # and submit
    $form.get(0).submit()

Neighborly.Neighborly.Balanced.Creditcard.Payments.New = Backbone.View.extend
  el: '.neighborly-balanced-creditcard-form'

  initialize: ->
    _.bindAll(this, 'submit', 'submitToBalanced', 'toggleAddNewCard', 'toggleSelected')
    this.Flash = Neighborly.Neighborly.Balanced.Creditcard.Flash

    $.getScript 'https://js.balancedpayments.com/v1/balanced.js', ->
      balancedMarketplaceID = $('[data-balanced-credit-card-form]').attr('data-balanced-marketplace-id')
      balanced.init("/v1/marketplaces/#{balancedMarketplaceID}")

    this.$button = this.$('input[type=submit]')
    this.$('form').bind('submit', this.submit)
    this.$('input[type=radio]').bind('change', this.toggleAddNewCard)
    this.$('input[type=radio]').bind('change', this.toggleSelected)
    this.toggleSelected()

  submit: (event) ->
    Stripe.setPublishableKey "pk_live_bnlgjzPEu9hbH1jH5Suikywb"

    if $("input[name='payment[use_card]']").val() is "new"
      event.preventDefault()
      $form = $(this)
      
      # Disable the submit button to prevent repeated clicks
      $form.find("button").prop "disabled", true
      Stripe.card.createToken $form, stripeResponseHandler
      
      # Prevent the form from submitting with the default action
      
      false
    else
      true

  submitToBalanced: (selectedCard) ->
    that = this
    $.rails.disableFormElements(that.$el)

    creditCardData =
      card_number:      this.$('#payment_card_number').val()
      expiration_month: this.$('#payment_expiration_month').val()
      expiration_year:  this.$('#payment_expiration_year').val()
      security_code:    this.$('#payment_security_code').val()
      name:             this.$('#payment_user_name').val()
      postal_code:      this.$('#payment_user_address_zip_code').val()
      country_code:     'USA'

    balanced_callback_for_201 = (response) ->
      selectedCard.val(response.data.uri)
      that.$('[data-balanced-credit-card-input]').val('')
      that.$('form').submit()
      that.Flash.remove()

    <% i18n_scope = 'neighborly.balanced.creditcard.payments.new.errors' %>

    balanced_callback_for_400 = (response) ->
      that.Flash.message('<%= I18n.t("#{i18n_scope}.invalid_card") %>')

    balanced_callback_for_402 = (response) ->
      that.Flash.message('<%= I18n.t("#{i18n_scope}.card_tokenization_error") %>')

    balanced_callback_for_404 = (response) ->
      

    balanced_callback_for_500 = (response) ->
      that.Flash.message('<%= I18n.t("#{i18n_scope}.balanced") %>')

    balanced.card.create creditCardData, (response) ->
      switch response.status
        when 201 then balanced_callback_for_201(response)
        when 400 then balanced_callback_for_400(response)
        when 402 then balanced_callback_for_402(response)
        when 404 then balanced_callback_for_404(response)
        when 500 then balanced_callback_for_500(response)

      if response.status != 201
        $.rails.enableFormElements(that.$el)
        $submit = that.$('input[type=submit]')
        $submit.val($submit.data('enable-with'))

  toggleSelected: ->
    this.$('.card-box').removeClass('selected')
    this.$('input[type=radio]:checked').parents('.card-box').addClass('selected')

  toggleAddNewCard: ->
    if this.$('#payment_use_card_new').is(':checked')
      this.$('.add-new-creditcard-form').removeClass('hide')
    else
      this.$('.add-new-creditcard-form').addClass('hide')
